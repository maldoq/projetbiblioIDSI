{% extends 'base.html' %}

{% block title %}Historique - Bibliothèque{% endblock %}
{% block page_title %}Historique complet{% endblock %}

{% block content %}
<!-- Filters -->
<div class="card">
    <div class="card-body">
        <form method="get" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="search">Rechercher</label>
                <input 
                    type="text" 
                    id="search" 
                    name="search" 
                    placeholder="Utilisateur, livre..."
                    value="{{ search_query }}"
                >
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label for="action_type">Type d'action</label>
                <select id="action_type" name="action_type">
                    <option value="">Toutes les actions</option>
                    <option value="loan" {% if action_type == 'loan' %}selected{% endif %}>Emprunt</option>
                    <option value="return" {% if action_type == 'return' %}selected{% endif %}>Retour</option>
                    <option value="add_book" {% if action_type == 'add_book' %}selected{% endif %}>Ajout livre</option>
                    <option value="add_user" {% if action_type == 'add_user' %}selected{% endif %}>Ajout utilisateur</option>
                    <option value="update" {% if action_type == 'update' %}selected{% endif %}>Modification</option>
                    <option value="delete" {% if action_type == 'delete' %}selected{% endif %}>Suppression</option>
                </select>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label for="date_from">Date début</label>
                <input 
                    type="date" 
                    id="date_from" 
                    name="date_from"
                    value="{{ date_from }}"
                >
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label for="date_to">Date fin</label>
                <input 
                    type="date" 
                    id="date_to" 
                    name="date_to"
                    value="{{ date_to }}"
                >
            </div>

            <div class="btn-group" style="margin-bottom: 0;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter"></i>
                    Filtrer
                </button>
                <a href="{% url 'history' %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i>
                    Réinitialiser
                </a>
            </div>
        </form>
    </div>
</div>

<!-- History Timeline -->
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-history"></i> Journal d'activités</h3>
        <div class="btn-group">
            <button class="btn btn-sm btn-secondary" onclick="window.print()">
                <i class="fas fa-print"></i>
                Imprimer
            </button>
            <a href="{% url 'history_export' %}" class="btn btn-sm btn-success">
                <i class="fas fa-file-excel"></i>
                Exporter CSV
            </a>
        </div>
    </div>
    <div class="card-body">
        <!-- Timeline -->
        <div style="position: relative; padding-left: 40px;">
            <!-- Timeline Line -->
            <div style="position: absolute; left: 15px; top: 0; bottom: 0; width: 2px; background: #e5e7eb;"></div>

            {% for activity in activities %}
            <div style="position: relative; margin-bottom: 24px;">
                <!-- Timeline Dot -->
                <div style="position: absolute; left: -32px; width: 12px; height: 12px; border-radius: 50%; background: 
                    {% if activity.action_type == 'loan' %}#3b82f6
                    {% elif activity.action_type == 'return' %}#10b981
                    {% elif activity.action_type == 'add_book' or activity.action_type == 'add_user' %}#8b5cf6
                    {% elif activity.action_type == 'update' %}#f59e0b
                    {% elif activity.action_type == 'delete' %}#ef4444
                    {% else %}#6b7280{% endif %};
                    border: 3px solid white; box-shadow: 0 0 0 2px
                    {% if activity.action_type == 'loan' %}#3b82f6
                    {% elif activity.action_type == 'return' %}#10b981
                    {% elif activity.action_type == 'add_book' or activity.action_type == 'add_user' %}#8b5cf6
                    {% elif activity.action_type == 'update' %}#f59e0b
                    {% elif activity.action_type == 'delete' %}#ef4444
                    {% else %}#6b7280{% endif %};"></div>

                <!-- Activity Card -->
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-{{ activity.icon }}" style="color: 
                                {% if activity.action_type == 'loan' %}#3b82f6
                                {% elif activity.action_type == 'return' %}#10b981
                                {% elif activity.action_type == 'add_book' or activity.action_type == 'add_user' %}#8b5cf6
                                {% elif activity.action_type == 'update' %}#f59e0b
                                {% elif activity.action_type == 'delete' %}#ef4444
                                {% else %}#6b7280{% endif %}; font-size: 18px;"></i>
                            <div>
                                <strong style="font-size: 15px; color: #111827;">{{ activity.title }}</strong>
                                <p style="margin: 4px 0 0 0; font-size: 14px; color: #6b7280;">{{ activity.description }}</p>
                            </div>
                        </div>
                        <span style="font-size: 13px; color: #9ca3af; white-space: nowrap;">
                            <i class="fas fa-clock"></i>
                            {{ activity.timestamp|date:"d/m/Y H:i" }}
                        </span>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        {% if activity.user %}
                        <span class="badge badge-secondary">
                            <i class="fas fa-user"></i>
                            {{ activity.user }}
                        </span>
                        {% endif %}
                        {% if activity.performed_by %}
                        <span class="badge badge-info" style="font-size: 11px;">
                            Par: {{ activity.performed_by }}
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="pagination">
            {% if page_obj.has_previous %}
            <a href="?page=1">&laquo; Première</a>
            <a href="?page={{ page_obj.previous_page_number }}">Précédent</a>
            {% endif %}

            <span class="current">
                Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">Suivant</a>
            <a href="?page={{ page_obj.paginator.num_pages }}">Dernière &raquo;</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}