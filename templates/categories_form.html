{% extends 'base.html' %}

{% if category %}
    {% url 'categories_edit' category.id as form_url %}
{% else %}
    {% url 'categories_form' as form_url %}
{% endif %}

{% block title %}{% if category %}Modifier{% else %}Ajouter{% endif %} une cat√©gorie - Biblioth√®que{% endblock %}
{% block page_title %}{% if category %}Modifier{% else %}Ajouter{% endif %} une cat√©gorie{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>
            <i class="fas fa-tag"></i>
            {% if category %}Modifier la cat√©gorie{% else %}Nouvelle cat√©gorie{% endif %}
        </h3>
        <a href="{% url 'categories_list' %}" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-left"></i>
            Retour aux cat√©gories
        </a>
    </div>
    <div class="card-body">
        <form method="post" action="{{ form_url }}">
            {% csrf_token %}
            
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px;">
                <!-- Form Fields -->
                <div>
                    <div class="form-group">
                        <label for="nom">
                            Nom de la cat√©gorie <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="nom" 
                            name="nom" 
                            value="{{ category.nom }}"
                            placeholder="Ex: Science-Fiction"
                            required
                        >
                        <span class="form-help">Nom unique de la cat√©gorie</span>
                    </div>

                    <div class="form-group">
                        <label for="description">
                            Description
                        </label>
                        <textarea 
                            id="description" 
                            name="description" 
                            placeholder="Br√®ve description de cette cat√©gorie..."
                            rows="4"
                        >{{ category.description }}</textarea>
                        <span class="form-help">Description optionnelle pour aider √† identifier la cat√©gorie</span>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label for="icone">
                                Ic√¥ne <span class="required">*</span>
                            </label>
                            <select id="icone" name="icone" required>
                                <option value="">-- Choisir une ic√¥ne --</option>
                                {% for val, label in ICONE_CHOICES %}
                                    <option value="{{ val }}" {% if category.icone == val %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                            <span class="form-help">Ic√¥ne repr√©sentant la cat√©gorie</span>
                        </div>

                        <div class="form-group">
                            <label for="couleur">
                                Couleur <span class="required">*</span>
                            </label>
                            <select id="couleur" name="couleur" required style="padding: 10px 14px;">
                                <option value="">-- Choisir une couleur --</option>
                                <option value="#3b82f6" {% if category.couleur == "#3b82f6" %}selected{% endif %} style="background: #3b82f620; color: #3b82f6; font-weight: 600;">üîµ Bleu</option>
                                <option value="#10b981" {% if category.couleur == "#10b981" %}selected{% endif %} style="background: #10b98120; color: #10b981; font-weight: 600;">üü¢ Vert</option>
                                <option value="#8b5cf6" {% if category.couleur == "#8b5cf6" %}selected{% endif %} style="background: #8b5cf620; color: #8b5cf6; font-weight: 600;">üü£ Violet</option>
                                <option value="#f59e0b" {% if category.couleur == "#f59e0b" %}selected{% endif %} style="background: #f59e0b20; color: #f59e0b; font-weight: 600;">üü† Orange</option>
                                <option value="#ef4444" {% if category.couleur == "#ef4444" %}selected{% endif %} style="background: #ef444420; color: #ef4444; font-weight: 600;">üî¥ Rouge</option>
                                <option value="#ec4899" {% if category.couleur == "#ec4899" %}selected{% endif %} style="background: #ec489920; color: #ec4899; font-weight: 600;">üå∏ Rose</option>
                                <option value="#06b6d4" {% if category.couleur == "#06b6d4" %}selected{% endif %} style="background: #06b6d420; color: #06b6d4; font-weight: 600;">üî∑ Cyan</option>
                                <option value="#84cc16" {% if category.couleur == "#84cc16" %}selected{% endif %} style="background: #84cc1620; color: #84cc16; font-weight: 600;">üü¢ Lime</option>
                                <option value="#f97316" {% if category.couleur == "#f97316" %}selected{% endif %} style="background: #f9731620; color: #f97316; font-weight: 600;">üüß Orange fonc√©</option>
                                <option value="#6366f1" {% if category.couleur == "#6366f1" %}selected{% endif %} style="background: #6366f120; color: #6366f1; font-weight: 600;">üîµ Indigo</option>
                            </select>
                            <span class="form-help">Couleur d'identification</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="slug">
                            Slug (URL)
                        </label>
                        <input 
                            type="text" 
                            id="slug" 
                            name="slug" 
                            value="{{ category.slug_url }}"
                            placeholder="Ex: science-fiction"
                        >
                        <span class="form-help">G√©n√©r√© automatiquement si laiss√© vide</span>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input 
                                type="checkbox" 
                                name="is_active" 
                                {% if category.is_active or not category %}checked{% endif %}
                            >
                            <span>Cat√©gorie active</span>
                        </label>
                        <span class="form-help">Les cat√©gories inactives ne sont pas visibles</span>
                    </div>
                </div>

                <!-- Preview Card -->
                <div>
                    <div style="background: #f9fafb; border-radius: 12px; padding: 20px; position: sticky; top: 100px;">
                        <h4 style="font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px;">
                            Aper√ßu
                        </h4>
                        
                        <!-- Preview Card -->
                        <div id="preview-card" style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div id="preview-icon-container" style="width: 48px; height: 48px; border-radius: 10px; background: #3b82f620; display: flex; align-items: center; justify-content: center;">
                                    <i id="preview-icon" class="fas fa-book" style="font-size: 24px; color: #3b82f6;"></i>
                                </div>
                            </div>
                            <h4 id="preview-name" style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 8px;">
                                Nom de la cat√©gorie
                            </h4>
                            <p id="preview-description" style="font-size: 14px; color: #6b7280; margin-bottom: 16px; min-height: 40px;">
                                Description de la cat√©gorie
                            </p>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                <div>
                                    <div style="font-size: 24px; font-weight: 700; color: #111827;">{{ category.book_count|default:"0" }}</div>
                                    <div style="font-size: 12px; color: #6b7280;">Livres</div>
                                </div>
                                <div class="btn btn-sm btn-primary" style="pointer-events: none;">
                                    <i class="fas fa-arrow-right"></i>
                                    Voir les livres
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 16px; padding: 12px; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 4px;">
                            <div style="font-size: 12px; color: #1e40af;">
                                <i class="fas fa-info-circle"></i>
                                <strong>Astuce:</strong> Les modifications sont pr√©visualis√©es en temps r√©el
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="btn-group" style="justify-content: flex-end; margin-top: 24px;">
                <a href="{% url 'categories_list' %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i>
                    Annuler
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    {% if category %}Mettre √† jour{% else %}Enregistrer{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Live preview update
const nameInput = document.getElementById('nom');
const descriptionInput = document.getElementById('description');
const iconSelect = document.getElementById('icone');
const colorSelect = document.getElementById('couleur');

const previewName = document.getElementById('preview-name');
const previewDescription = document.getElementById('preview-description');
const previewIcon = document.getElementById('preview-icon');
const previewIconContainer = document.getElementById('preview-icon-container');

// Live preview
nameInput.addEventListener('input', function() {
    previewName.textContent = this.value || 'Nom de la cat√©gorie';
});

descriptionInput.addEventListener('input', function() {
    previewDescription.textContent = this.value || 'Description de la cat√©gorie';
});

iconSelect.addEventListener('change', function() {
    previewIcon.className = `fas fa-${this.value || 'book'}`;
});

colorSelect.addEventListener('change', function() {
    const color = this.value || '#3b82f6';
    previewIcon.style.color = color;
    previewIconContainer.style.background = color + '20';
});

// Slug
nameInput.addEventListener('input', function() {
    const slugInput = document.getElementById('slug');
    if (!slugInput.value || slugInput.dataset.autoGenerated) {
        const slug = this.value
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '');
        slugInput.value = slug;
        slugInput.dataset.autoGenerated = 'true';
    }
});

function initPreview() {
    // Nom
    if (nameInput.value) {
        previewName.textContent = nameInput.value;
    }

    // Description
    if (descriptionInput.value) {
        previewDescription.textContent = descriptionInput.value;
    }

    // Ic√¥ne
    if (iconSelect.value) {
        previewIcon.className = `fas fa-${iconSelect.value}`;
    }

    // Couleur
    if (colorSelect.value) {
        previewIcon.style.color = colorSelect.value;
        previewIconContainer.style.background = colorSelect.value + '20';
    }
}

// ex√©cuter au chargement de la page
initPreview();

</script>
{% endblock %}